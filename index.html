<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meldebestätigung Decodierer - Modellvorhaben Genomsequenzierung</title>

    <!-- CSS Reset -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css"
    />

    <!-- Milligram CSS für minimales Styling -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css"
      xintegrity="sha512-xiunq9hpKsIcz42zt0o2vcojRESifN+YroiL55NDBFU7EaZtNo8vyvr8BINnGS"
      crossorigin="anonymous"
    />

    <style>
      /* Rosé Pine Palette variables (Dawn + Moon) */
      :root {
        /* Dawn */
        --rp-dawn-base: #faf4ed;
        --rp-dawn-surface: #fffaf3;
        --rp-dawn-overlay: #f2e9e1;
        --rp-dawn-muted: #9893a5;
        --rp-dawn-subtle: #797593;
        --rp-dawn-text: #575279;
        --rp-dawn-love: #b4637a;
        --rp-dawn-gold: #ea9d34;
        --rp-dawn-rose: #d7827e;
        --rp-dawn-pine: #286983;
        --rp-dawn-foam: #56949f;
        --rp-dawn-iris: #907aa9;
        --rp-dawn-highlight-low: #f4ede8;
        --rp-dawn-highlight-med: #dfdad9;
        --rp-dawn-highlight-high: #cecacd;

        /* Moon */
        --rp-moon-base: #232136;
        --rp-moon-surface: #2a273f;
        --rp-moon-overlay: #393552;
        --rp-moon-muted: #6e6a86;
        --rp-moon-subtle: #908caa;
        --rp-moon-text: #e0def4;
        --rp-moon-love: #eb6f92;
        --rp-moon-gold: #f6c177;
        --rp-moon-rose: #ea9a97;
        --rp-moon-pine: #3e8fb0;
        --rp-moon-foam: #9ccfd8;
        --rp-moon-iris: #c4a7e7;
        --rp-moon-highlight-low: #2a283e;
        --rp-moon-highlight-med: #44415a;
        --rp-moon-highlight-high: #56526e;

        /* App theme tokens (light defaults = Dawn) */
        color-scheme: light;
        --bg: var(--rp-dawn-base);
        --text: var(--rp-dawn-text);
        --panel: var(--rp-dawn-surface);
        --overlay: var(--rp-dawn-overlay);
        --muted: var(--rp-dawn-muted);
        --subtle: var(--rp-dawn-subtle);
        --link: var(--rp-dawn-iris);
        --border: var(--rp-dawn-highlight-high);
        --accent: var(--rp-dawn-iris);
        --error: var(--rp-dawn-love);
        --warn: var(--rp-dawn-gold);
        --ok: var(--rp-dawn-pine);
        --info: var(--rp-dawn-foam);
        --code-bg: var(--rp-dawn-highlight-low);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          color-scheme: dark;
          --bg: var(--rp-moon-base);
          --text: var(--rp-moon-text);
          --panel: var(--rp-moon-surface);
          --overlay: var(--rp-moon-overlay);
          --muted: var(--rp-moon-muted);
          --subtle: var(--rp-moon-subtle);
          --link: var(--rp-moon-iris);
          --border: var(--rp-moon-highlight-high);
          --accent: var(--rp-moon-iris);
          --error: var(--rp-moon-love);
          --warn: var(--rp-moon-gold);
          --ok: var(--rp-moon-pine);
          --info: var(--rp-moon-foam);
          --code-bg: var(--rp-moon-highlight-low);
        }
      }

      /* Basistypografie und Layout */
      body {
        font-family: Avenir, Montserrat, Corbel, "URW Gothic", source-sans-pro,
          sans-serif;
        margin-top: 2rem;
        background: var(--bg);
        color: var(--text);
      }
      .container {
        max-width: 960px;
      }
      a {
        color: var(--link);
      }
      textarea {
        font-family: "Nimbus Mono PS", "Courier New", monospace;
      }
      pre,
      code {
        background: var(--code-bg);
      }

      #results {
        margin-top: 2rem;
        padding: 1.5rem;
        background-color: var(--panel);
        border: 1px solid var(--border);
        border-radius: 4px;
        display: none; /* Wird per JS eingeblendet */
      }
      /* Definitionsliste für die Ergebnisse */
      dl {
        margin-bottom: 1.5rem;
      }
      dt {
        font-weight: bold;
        color: var(--subtle);
        width: 30%;
        float: left;
        clear: left;
        margin-bottom: 0.5rem;
      }
      dd {
        width: 70%;
        float: left;
        margin-left: 0;
        margin-bottom: 0.5rem;
      }
      dl::after {
        content: "";
        display: table;
        clear: both;
      }
      .error {
        color: var(--error);
        font-weight: bold;
      }
      .success {
        color: var(--ok);
        font-weight: bold;
      }
      .validation-ok {
        color: var(--ok);
        font-weight: bold;
      }
      .validation-warn {
        color: var(--warn);
        font-weight: bold;
      }
      h3 {
        border-bottom: 2px solid var(--border);
        padding-bottom: 5px;
      }
      h4 {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 1rem;
      }
      .site-footer {
        margin-top: 3rem;
        padding: 1rem 0;
        border-top: 1px solid var(--border);
        font-size: 1.2rem;
        color: var(--muted);
      }
      .site-footer p {
        margin: 0;
      }

      input,
      select,
      textarea {
        background: var(--panel);
        color: var(--text);
        border-color: var(--border);
      }

      button,
      .button,
      .button-primary {
        background: var(--overlay);
        border-color: var(--accent);
        color: var(--text);
      }

      hr,
      table,
      th,
      td {
        border-color: var(--border);
      }
    </style>
  </head>
  <body>
    <main class="container">
      <h1>Modellvorhaben Genomsequenzierung</h1>
      <h2>Meldebestätigung Decodierer</h2>
      <p>
        Fügen Sie den vollständigen IBE-Segment-String aus der Meldebestätigung
        ein, um die enthaltenen Daten zu decodieren.
      </p>

      <form>
        <fieldset>
          <label for="ibeInput">IBE-Segment-String</label>
          <textarea
            placeholder="z.B. IBE+A123456789+A123456789&20240701001..."
            id="ibeInput"
          ></textarea>
          <button type="button" class="button button-primary" id="parseButton">
            String analysieren
          </button>
        </fieldset>
      </form>

      <div id="results"></div>
    </main>

    <footer class="site-footer">
      <div class="container">
        <p>
          <a
            href="https://github.com/MHH-Humangenetik/MVH_Receipt_Decoder"
            target="_blank"
            rel="noopener noreferrer"
            >MVH_Receipt_Decoder</a
          >
          erstellt von
          <a
            href="https://github.com/BeneKenobi"
            target="_blank"
            rel="noopener noreferrer"
            >@BeneKenobi</a
          >
          für das
          <a
            href="https://github.com/MHH-Humangenetik"
            target="_blank"
            rel="noopener noreferrer"
            >Institut für Humangenetik der MHH</a
          >
        </p>
      </div>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const ibeInput = document.getElementById("ibeInput");
        const parseButton = document.getElementById("parseButton");
        const resultsContainer = document.getElementById("results");

        parseButton.addEventListener("click", parseIBEString);

        function showError(message) {
          resultsContainer.innerHTML = `<h3 class="error">Fehler bei der Analyse</h3><p>${message}</p>`;
          resultsContainer.style.display = "block";
        }

        function decodeTyp(code) {
          switch (code) {
            case "0":
              return "Erstmeldung";
            case "1":
              return "Follow-Up";
            case "2":
              return "Nachmeldung";
            case "3":
              return "Korrektur";
            case "9":
              return "Testmeldung";
            default:
              return "Unbekannter Code";
          }
        }

        function decodeIndikation(code) {
          switch (code) {
            case "O":
              return "Onkologische Erkrankung";
            case "R":
              return "Seltene Erkrankung";
            case "H":
              return "Hereditäres Tumorprädispositionssyndrom";
            default:
              return "Unbekannter Code";
          }
        }

        function decodeProdukt(code) {
          switch (code) {
            case "9":
              return "MV GenomSeq";
            case "0":
              return "Keine";
            case "1":
              return "Spezialangefertigtes Implantat oder Implantat mit Sonderzulassung";
            default:
              return "Unbekannter Code";
          }
        }

        function decodeKosten(code) {
          switch (code) {
            case "1":
              return "GKV";
            case "2":
              return "PKV";
            case "3":
              return "PKV/Beihilfe";
            case "4":
              return "Andere";
            default:
              return "Unbekannter Code";
          }
        }

        function decodeDaten(code) {
          switch (code) {
            case "C":
              return "Klinische Daten";
            case "G":
              return "Genomische Daten";
            default:
              return "Unbekannter Code";
          }
        }

        function decodeSequenzierung(code) {
          switch (code) {
            case "0":
              return "Keine";
            case "1":
              return "WGS";
            case "2":
              return "WES";
            case "3":
              return "Panel";
            case "4":
              return "WGS_LR";
            default:
              return "Unbekannter Code";
          }
        }

        function decodeQC(code) {
          switch (code) {
            case "0":
              return "Nicht bestanden";
            case "1":
              return "Bestanden";
            default:
              return "Unbekannter Code";
          }
        }

        async function sha256(message) {
          try {
            // 1. Text in einen Buffer umwandeln (UTF-8)
            const msgBuffer = new TextEncoder().encode(message);

            // 2. Hash berechnen
            const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);

            // 3. Buffer in ein Array von Bytes umwandeln
            const hashArray = Array.from(new Uint8Array(hashBuffer));

            // 4. Jedes Byte in einen Hex-String umwandeln (mit '0' padding)
            const hashHex = hashArray
              .map((b) => b.toString(16).padStart(2, "0"))
              .join("");

            return hashHex;
          } catch (e) {
            console.error("SHA-256 Fehler:", e);
            return "Fehler bei der Hash-Berechnung";
          }
        }

        async function parseIBEString() {
          const input = ibeInput.value.trim();

          try {
            const ibeParts = input.split("+");

            if (ibeParts.length !== 5 || ibeParts[0] !== "IBE") {
              showError(
                `Der String ist kein valides IBE-Segment. Erwartet: 5 Teile, beginnend mit 'IBE'. Gefunden: ${ibeParts.length} Teile.`
              );
              return;
            }

            const ibeSegment = {
              kennung: ibeParts[0],
              idMeldebestaetigung: ibeParts[1],
              hashString: ibeParts[2],
              produktzuordnung: ibeParts[3],
              hashWert: ibeParts[4],
            };

            const hashParts = ibeSegment.hashString.split("&");

            if (hashParts.length !== 11) {
              showError(
                `Der Hash-String ist nicht valide. Erwartet: 11 Teile, getrennt mit '&'. Gefunden: ${hashParts.length} Teile.`
              );
              return;
            }

            const hashData = {
              alphaCode: hashParts[0],
              leistung: hashParts[1],
              leisterID: hashParts[2],
              knotenID: hashParts[3],
              typ: hashParts[4],
              indikation: hashParts[5],
              produkt: hashParts[6],
              kosten: hashParts[7],
              daten: hashParts[8],
              seq: hashParts[9],
              qc: hashParts[10],
            };

            const calculatedHash = await sha256(ibeSegment.hashString);
            const hashMatch = calculatedHash === ibeSegment.hashWert;

            const idMatch =
              ibeSegment.idMeldebestaetigung === hashData.alphaCode;
            const produktMatch =
              ibeSegment.produktzuordnung === hashData.produkt;

            const isErstmeldung = hashData.typ === "0";
            const isQCBestanden = hashData.qc === "1";
            const isMVHProdukt = hashData.produkt === "9";
            const isAbrechnungsrelevant =
              isErstmeldung && isQCBestanden && isMVHProdukt;

            buildResultHtml(
              ibeSegment,
              hashData,
              idMatch,
              produktMatch,
              isAbrechnungsrelevant,
              isMVHProdukt,
              isErstmeldung,
              hashMatch,
              calculatedHash
            );
            resultsContainer.style.display = "block";
          } catch (e) {
            console.error("Parser-Fehler:", e);
            showError(`Ein unerwarteter Fehler ist aufgetreten: ${e.message}`);
          }
        }

        function buildResultHtml(
          ibe,
          hash,
          idMatch,
          produktMatch,
          isAbrechnungsrelevant,
          isMVHProdukt,
          isErstmeldung,
          hashMatch,
          calculatedHash
        ) {
          const datum = hash.leistung.substring(0, 8);
          const zaehler = hash.leistung.substring(8);
          const datumFormatted =
            datum.length === 8
              ? `${datum.substring(0, 4)}-${datum.substring(
                  4,
                  6
                )}-${datum.substring(6, 8)}`
              : "Ungültiges Datum";

          let html = "";

          if (isAbrechnungsrelevant && hashMatch) {
            html += `<h3 class="success">Abrechnungsrelevant</h3>`;
          } else if (!hashMatch) {
            html += `<h3 class="error">HASH-FEHLER!</h3>`;
          } else {
            html += `<h3 class="validation-warn">Nicht abrechnungsrelevant!</h3>`;
            let grund = "";
            if (hash.typ !== "0")
              grund += `<li>Typ ist '${hash.typ}' (${decodeTyp(
                hash.typ
              )}), nicht '0' (Erstmeldung).</li>`;
            if (hash.qc !== "1")
              grund += `<li>QC ist '${hash.qc}' (${decodeQC(
                hash.qc
              )}), nicht '1' (Bestanden).</li>`;
            if (hash.produkt !== "9")
              grund += `<li>Produkt ist '${hash.produkt}' (${decodeProdukt(
                hash.produkt
              )}), nicht '9' (MV GenomSeq).</li>`;
            html += `<div style="border-left: 4px solid var(--warn); padding-left: 1rem;"><h4>Grund:</h4><ul>${grund}</ul></div>`;
          }

          html += "<h3>Details aus Hash-String</h3>";
          html += "<dl>";
          html += `<dt>Alphanum. Code</dt>
                         <dd>${hash.alphaCode} 
                            <span class="${
                              idMatch ? "validation-ok" : "error"
                            }">
                                (${
                                  idMatch
                                    ? "OK"
                                    : "FEHLER: Nicht identisch mit ID Meldebest."
                                })
                            </span>
                         </dd>`;
          html += `<dt>Leistungsdatum</dt><dd>${datumFormatted} (Zähler: ${zaehler})</dd>`;
          html += `<dt>ID Leisterbringer</dt><dd>${hash.leisterID}</dd>`;
          html += `<dt>ID Datenknoten</dt><dd>${hash.knotenID}</dd>`;
          html += `<dt>Typ der Meldung</dt><dd>${hash.typ} <span class="${
            hash.typ == 0 ? "validation-ok" : "validation-warn"
          }">(${decodeTyp(hash.typ)})</span></dd>`;
          html += `<dt>Indikationsbereich</dt><dd>${
            hash.indikation
          } (${decodeIndikation(hash.indikation)})</dd>`;
          html += `<dt>Produktzuordnung</dt>
                         <dd>${hash.produkt} (${decodeProdukt(hash.produkt)})
                            <span class="${
                              produktMatch && isMVHProdukt
                                ? "validation-ok"
                                : "error"
                            }">
                                (${
                                  produktMatch && isMVHProdukt
                                    ? "OK"
                                    : !produktMatch
                                    ? "FEHLER: Nicht identisch mit Produktzuordnung"
                                    : "FEHLER: Nicht MV GenomSeq (9)"
                                })
                            </span>
                         </dd>`;
          html += `<dt>Kostenträger</dt><dd>${hash.kosten} (${decodeKosten(
            hash.kosten
          )})</dd>`;
          html += `<dt>Art der Daten</dt><dd>${hash.daten} (${decodeDaten(
            hash.daten
          )})</dd>`;
          html += `<dt>Art der Sequenzierung</dt><dd>${
            hash.seq
          } (${decodeSequenzierung(hash.seq)})</dd>`;
          html += `<dt>Ergebnis QC</dt><dd>${hash.qc} <span class="${
            hash.qc == 1 ? "validation-ok" : "error"
          }">(${decodeQC(hash.qc)})</span></dd>`;
          html += "</dl>";

          html += "<h3>IBE-Segment-Daten</h3>";
          html += "<dl>";
          html += `<dt>Kennung</dt><dd>${ibe.kennung}</dd>`;
          html += `<dt>ID Meldebest.</dt><dd>${ibe.idMeldebestaetigung}</dd>`;
          html += `<dt>Hash-String</dt><dd style="word-break: break-all;">${ibe.hashString}</dd>`;
          html += `<dt>Produktzuordnung</dt><dd>${
            ibe.produktzuordnung
          } (${decodeProdukt(ibe.produktzuordnung)})</dd>`;
          html += `<dt>Hashwert (Übermittelt)</dt><dd style="word-break: break-all;">${ibe.hashWert}</dd>`;

          html += `<dt style="color: var(--info);"><em>Berechneter Hash</em></dt>
                         <dd style="word-break: break-all;">
                            ${calculatedHash} 
                            <br /><span class="${
                              hashMatch ? "validation-ok" : "error"
                            }">(${
            hashMatch ? "Stimmt überein" : "FEHLER: Stimmt NICHT überein!"
          })
                            </span>
                         </dd>`;

          html += "</dl>";

          resultsContainer.innerHTML = html;
        }
      });
    </script>
  </body>
</html>
